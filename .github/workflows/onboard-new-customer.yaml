name: onboard new customer

on:
  workflow_dispatch:
    inputs:
      customer_name:
        description: 'Name of the customer (will be prefixed with sysult-)'
        required: true
        type: string
      cluster_app_mapping:
        description: 'Format: cluster1:app1,app2;cluster2:app3,app4'
        required: true
        type: string

jobs:
  create-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout Source Catalog
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and Populate Customer Repo
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
          CUSTOMER_NAME: ${{ inputs.customer_name }}
          MAPPING: ${{ inputs.cluster_app_mapping }}
        run: |
          REPO_NAME="sysult-${CUSTOMER_NAME}"
          ORG_NAME=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f1)
          FULL_REPO_PATH="${ORG_NAME}/${REPO_NAME}"

          echo "Creating repository: ${FULL_REPO_PATH}"
          
          gh repo create "${FULL_REPO_PATH}" --private || echo "Repository might already exist"

          # Create a temporary directory for the new repo
          TEMP_DIR=$(mktemp -d)
          gh repo clone "${FULL_REPO_PATH}" "${TEMP_DIR}"

          cd "${TEMP_DIR}"

          # Initialize with a dummy commit if empty
          if [ ! -d ".git" ]; then
             echo "Failed to clone or repo not initialized"
             exit 1
          fi

          # Copy core files from the source catalog (which is at $GITHUB_WORKSPACE)
          echo "Copying core files..."
          cp "$GITHUB_WORKSPACE/Makefile" .
          cp "$GITHUB_WORKSPACE/go.mod" .
          cp "$GITHUB_WORKSPACE/go.sum" .
          cp -r "$GITHUB_WORKSPACE/internal" .
          cp -r "$GITHUB_WORKSPACE/scripts" .
          cp -r "$GITHUB_WORKSPACE/tools" .
          
          # Create clusters and copy apps
          echo "Creating clusters and copying apps from mapping..."
          
          # Process each cluster segment (split by semicolon)
          IFS=';' read -ra SEGMENTS <<< "${MAPPING}"
          mkdir -p clusters

          for segment in "${SEGMENTS[@]}"; do
            segment=$(echo "$segment" | xargs) # trim whitespace
            if [ -z "$segment" ]; then continue; fi

            # Split cluster name from apps (split by colon)
            CLUSTER_NAME=$(echo "$segment" | cut -d':' -f1 | xargs)
            APPS_LIST=$(echo "$segment" | cut -d':' -f2 | xargs)

            echo "Processing cluster: ${CLUSTER_NAME}"
            mkdir -p "clusters/${CLUSTER_NAME}"
            
            # Process each app for this cluster (split by comma)
            IFS=',' read -ra APP_ARRAY <<< "${APPS_LIST}"
            for app in "${APP_ARRAY[@]}"; do
              app=$(echo "$app" | xargs) # trim whitespace
              if [ -z "$app" ]; then continue; fi

              if [ -d "$GITHUB_WORKSPACE/apps/${app}" ]; then
                echo "  Copying app: ${app} to clusters/${CLUSTER_NAME}/"
                cp -r "$GITHUB_WORKSPACE/apps/${app}" "clusters/${CLUSTER_NAME}/"
              else
                echo "  Warning: App ${app} not found in catalog"
              fi
            done
          done

          # Configure remote with token for authentication
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${FULL_REPO_PATH}.git"

          # Commit and Push
          git add .
          git commit -m "Initial setup for customer ${CUSTOMER_NAME}" || echo "No changes to commit"
          
          # Detect current branch and push it
          CURRENT_BRANCH=$(git branch --show-current)
          if [ -z "$CURRENT_BRANCH" ]; then CURRENT_BRANCH="main"; fi
          git push origin "$CURRENT_BRANCH"
